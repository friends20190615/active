package com.active.front.controller;import com.active.bean.VisitInfo;import com.active.common.utils.MapCache;import com.active.front.service.VisitService;import com.alibaba.fastjson.JSONObject;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import javax.servlet.http.HttpServletRequest;import java.util.List;/** * 参观报名controller * * @author ta * @date 2019/6/30 下午8:42 * @since 1.0 */@Controller@RequestMapping("/visit")public class VisitController {    private final static Logger logger = LoggerFactory.getLogger(VisitController.class);    @Autowired    private VisitService visitService;    @RequestMapping("newMember")    @ResponseBody    public String pullNewMember(VisitInfo visitInfo,HttpServletRequest request){        JSONObject res = new JSONObject();        res.put("code", 0);        res.put("msg", "success");        try {            String dategroup = request.getParameter("dategroup");            String business= request.getParameter("business");            String visitingtime= request.getParameter("visitingtime");            visitInfo.setVisitTime(visitingtime);            visitInfo.setProfession(business);            visitInfo.setAge(dategroup);            VisitInfo exit =visitService.getVisitInfo(visitInfo);            if(exit ==null){                if(MapCache.instance(visitInfo.getVisitTime()).incrementAndGet(visitInfo.getVisitTime()) > 80){                    //以达到上线                    res.put("code", 2);                    res.put("msg", "sorry,此时间点报名人数已满");                    return res.toJSONString();                }else{                    try{                        visitService.insertInfo(visitInfo);                    }catch (Exception e){                        logger.error("插入数据报错："+e.getMessage());                        res.put("code", -1);                        res.put("msg", "error");                        MapCache.instance(visitInfo.getVisitTime()).decrementAndGet(visitInfo.getVisitTime());                    }                }            }else{                //已经存在                res.put("code", 1);                res.put("msg", "手机号已报名");            }        }catch (Exception e){            logger.error("error："+e.getMessage());            res.put("code", -1);            res.put("msg", "error");        }        return res.toJSONString();    }    @RequestMapping("getList")    @ResponseBody    public String getList(VisitInfo visitInfo,HttpServletRequest request){        JSONObject res = new JSONObject();        res.put("code", 0);        res.put("msg", "success");        try {            visitInfo.setPageSize((visitInfo.getPage()-1)*visitInfo.getLimit());            List<VisitInfo> vis =visitService.getVisitInfos(visitInfo);            Integer count = visitService.getCount(visitInfo);            res.put("data",vis);            res.put("count",count);        }catch (Exception e){            logger.error("error："+e.getMessage());            res.put("code", -1);            res.put("msg", "error");        }        return res.toJSONString();    }}