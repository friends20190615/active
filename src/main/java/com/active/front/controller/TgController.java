package com.active.front.controller;import com.active.bean.TgInfo;import com.active.common.init.SpringInit;import com.active.front.service.TgService;import com.alibaba.fastjson.JSONObject;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Controller;import org.springframework.web.bind.annotation.RequestMapping;import org.springframework.web.bind.annotation.ResponseBody;import java.util.List;import java.util.Random;/** * 这是一个类说明 * * @author * @date 2019/11/16 上午10:46 * @since 1.0 */@Controller@RequestMapping("/tg")public class TgController {    private final static Logger logger = LoggerFactory.getLogger(TgController.class);    @Autowired    private TgService tgService;    @RequestMapping("cj")    @ResponseBody    public String cj(TgInfo tgInfo){        JSONObject res = new JSONObject();        res.put("status", 2);        res.put("msg", "success");        try {            TgInfo exit =tgService.getInfo(tgInfo.getMobile());            if(exit ==null){                int LIMIT_COUNT = 10;                if(cj()){                    if(SpringInit.TGCOUNT.get() >=LIMIT_COUNT){                        tgInfo.setStatus(0);                    }else{                        int count =tgService.getCount(1);                        if(count >= LIMIT_COUNT){                            tgInfo.setStatus(0);                        }else{                            tgInfo.setStatus(1);                            SpringInit.TGCOUNT.addAndGet(1);                            res.put("status", 0);                        }                    }                }else{                    tgInfo.setStatus(0);                }                try{                    tgService.addInfo(tgInfo);                }catch (Exception e){                    if(tgInfo.getStatus() == 1){                        SpringInit.TGCOUNT.decrementAndGet();                    }                    logger.error("error："+e.getMessage());                    res.put("status", -1);                    res.put("msg", "系统繁忙，请稍后重试");                }            }else{                //已经存在                res.put("status", 1);                res.put("msg", "success");            }        }catch (Exception e){            logger.error("error："+e.getMessage());            res.put("code", -1);            res.put("msg", "系统繁忙，请稍后重试");        }        return res.toJSONString();    }    private boolean cj() {        return new Random().nextInt(100) >= 80;    }    @RequestMapping("infos")    @ResponseBody    public String getList(TgInfo tgInfo){        JSONObject res = new JSONObject();        res.put("code", 0);        res.put("msg", "success");        try {            List<TgInfo> tgInfos =tgService.getInfos(tgInfo);            res.put("result",tgInfos);        }catch (Exception e){            logger.error("error："+e.getMessage());            res.put("code", -1);            res.put("msg", "error");        }        return res.toJSONString();    }}